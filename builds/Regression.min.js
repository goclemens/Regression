!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("mathjs")):"function"==typeof define&&define.amd?define(["mathjs"],e):t.Regression=e(t.math)}(this,function(t){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var e=function(){function e(e,r,a){var n=t.transpose(e);if(void 0==a||0==a)var s=t.multiply(t.inv(t.multiply(n,e)),n);else s=t.multiply(t.inv(t.add(t.multiply(n,e),a)),n);var i=t.multiply(s,r),l=t.multiply(e,i),o=t.multiply(e,s);return{estPara:i,fittedValues:l,projMatrix:o,dof:t.trace(o)}}return e.estPara=function(e,r,a){var n=t.transpose(e);if(void 0==a)var s=t.multiply(t.inv(t.multiply(n,e)),n);else s=t.multiply(t.inv(t.add(t.multiply(n,e),a)),n);return t.multiply(s,r)},e.fittedValues=function(e,r,a){var n=t.transpose(e);if(void 0==a)var s=t.multiply(t.inv(t.multiply(n,e)),n);else s=t.multiply(t.inv(t.add(t.multiply(n,e),a)),n);return t.multiply(e,t.multiply(s,r))},e.projMatrix=function(e,r,a){var n=t.transpose(e);if(void 0==a)var s=t.multiply(t.inv(t.multiply(n,e)),n);else s=t.multiply(t.inv(t.add(t.multiply(n,e),a)),n);return t.multiply(e,s)},e}(),r=new function(){function r(t,e){var r=e.length,a=[];a.length=t.length;for(let t=0;t<a.length;t++)a[t]=new Array(r+4);for(let n=0;n<t.length;n++){a[n][0]=1,a[n][1]=t[n],a[n][2]=Math.pow(t[n],2),a[n][3]=Math.pow(t[n],3);for(let s=0;s<r;s++)a[n][s+4]=Math.max(Math.pow(t[n]-e[s],3),0)}return a}this.defaults={regualizer:"Sq2ndDer",knots:!0},this.calcKnots=function(t){var e=t.X.map(t=>t);e.sort();for(let t=0;t<e.length-1;t++)e[t]==e[t+1]&&(e.splice(t,1),t--);return e},this.calcRegression=function(a){var n=a.data,s=a.knots,i=a.regualizer,l=a.lambda,o=a.interval||[s[0]-.05*(s[s.length-1]-s[0]),s[s.length-1]+.05*(s[s.length-1]-s[0])],u=r(n.X,s),h=function(e,r,a,n){switch(e){case"Sq2ndDer":var s=n[0],i=n[1],l=[];l.length=a.length+4;for(let t=0;t<l.length;t++)l[t]=new Array(l.length),l[t].fill(0);l[2][2]=4*(i-s),l[2][3]=6*(i*i-s*s),l[3][3]=12*(Math.pow(i,3)-Math.pow(s,3));for(let t=4;t<l.length;t++){l[t][2]=l[2][t]=6*i*(i-2*a[t-4])+6*Math.pow(a[t-4],2),l[t][3]=l[3][t]=6*Math.pow(i,2)*(2*i-3*a[t-4])+6*Math.pow(a[t-4],3);for(let e=t;e<l.length;e++)l[t][e]=l[e][t]=6*i*(i*(2*i-3*(a[t-4]+a[e-4]))+6*a[t-4]*a[e-4])+6*Math.pow(a[e-4],3)-18*Math.pow(a[e-4],2)*a[t-4]}return l=t.multiply(l,r);case"ridge":var l=t.multiply(t.eye(a.length+4).toArray(),r);return l[0][0]=0,l;case"none":var l=!1;return l;default:return console.log("truncPower: "+e+" is not a supported regualizer"),!1}}(i,l,s,o);return e(u,n.Y,h)},this.sample=function(e){var a=e.interval,n=e.res,s=e.estPara,i=e.knots,l=[];l.length=n;var o=(a[1]-a[0])/(n-1);for(let t=0;t<n;t++)l[t]=t*o+a[0];var u=r(l,i);return{X:l,Y:t.multiply(u,s)}},this.sampleDer=function(e){var r=e.interval,a=e.res,n=e.estPara,s=e.knots,i=[];i.length=a;var l=(r[1]-r[0])/(a-1);for(let t=0;t<a;t++)i[t]=t*l+r[0];var o=function(t,e){var r=e.length,a=[];a.length=t.length;for(let t=0;t<a.length;t++)a[t]=new Array(r+4);for(let n=0;n<t.length;n++){a[n][0]=0,a[n][1]=1,a[n][2]=2*t[n],a[n][3]=3*Math.pow(t[n],2);for(let s=0;s<r;s++)a[n][s+4]=t[n]>e[s]?3*Math.pow(t[n]-e[s],2):0}return a}(i,s);return{X:i,Y:t.multiply(o,n)}},this.sample2ndDer=function(e){var r=e.interval,a=e.res,n=e.estPara,s=e.knots,i=[];i.length=a;var l=(r[1]-r[0])/(a-1);for(let t=0;t<a;t++)i[t]=t*l+r[0];var o=function(t,e){var r=e.length,a=[];a.length=t.length;for(let t=0;t<a.length;t++)a[t]=new Array(r+4);for(let n=0;n<t.length;n++){a[n][0]=0,a[n][1]=0,a[n][2]=2,a[n][3]=6*t[n];for(let s=0;s<r;s++)a[n][s+4]=t[n]>e[s]?6*(t[n]-e[s]):0}return a}(i,s);return{X:i,Y:t.multiply(o,n)}},this.eval=function(e){var a=e.pos,n=e.knots,s=e.estPara,i=r([a],n);return{X:[a],Y:t.multiply(i,s)}},this.evalIntegral=function(e){var r=e.interval,a=e.knots,s=e.estPara,i=function(t,e){var r=e.length,a=t[0],s=t[1],i=[];i.length=n+4,i[0]=s-a,i[1]=.5*(Math.pow(s,2)-Math.pow(a,2)),i[2]=1/3*(Math.pow(s,3)-Math.pow(a,3)),i[3]=.25*(Math.pow(s,4)-Math.pow(a,4));for(let t=0;t<r;t++)i[t+4]=0,a>e[t]&&(i[t+4]+=.25*Math.pow(a-e[t],4)),s>e[t]&&(i[t+4]+=.25*Math.pow(s-e[t],4)),knot[t]<0&&(i[t+4]-=.25*Math.pow(knot[t],4));return i}(r,a);return t.multiply(i,s)},this.calcFittedValues=function(e){var a=e.data.X,n=e.knots,s=e.estPara,i=r(a,n);return{X:a,Y:t.multiply(i,s)}},this.analyticString=function(t){var e=t.knots,r=t.estPara,a="";a+=r[0],a+=r[1]>=0?"+"+r[1]+"x":r[1]+"x",a+=r[2]>=0?"+"+r[2]+"x^2":r[2]+"x^2",a+=r[3]>=0?"+"+r[3]+"x^3":r[3]+"x^3";for(let t=0;t<e.length;t++)a+=r[t+4]>=0?"+"+r[t+4]:r[t+4],a+=e[t]>=0?"(x+"+e[t]+")^3":NaN+e[t]+")^3";return a}},a=new function(){function r(t){var e=[];e.length=t.length;for(let t=0;t<e.length;t++)e[t]=new Array(2);for(let r=0;r<t.length;r++)e[r][0]=1,e[r][1]=t[r];return e}this.defaults={regualizer:"none",knots:!1},this.calcKnots=function(){return console.log("linear - no knots needed for this basis"),!1},this.calcRegression=function(t){var a=t.data,n=t.regualizer,s=t.lambda,i=r(a.X),l=function(t,e){switch(t){case"ridge":var r=[[0,0],[0,e]];return r;case"none":var r=!1;return r;default:return console.log("truncPower: "+t+" is not a supported regualizer"),!1}}(n,s);return e(i,a.Y,l)},this.analyticString=function(t){var e=t.estPara,r="";return r+=e[0],r+=e[1]>=0?"+"+e[1]+"x":e[1]+"x"},this.sample=function(e){var a=e.interval,n=e.res,s=e.estPara,i=[];i.length=n;var l=(a[1]-a[0])/(n-1);for(let t=0;t<n;t++)i[t]=t*l+a[0];var o=r(i);return{X:i,Y:t.multiply(o,s)}},this.sampleDer=function(t){var e=t.interval,r=t.res,a=t.estPara,n=[];n.length=r;var s=(e[1]-e[0])/(r-1);for(let t=0;t<r;t++)n[t]=t*s+e[0];var i=[];return i.length=r,i.fill(a[0]),{X:n,Y:i}},this.sample2ndDer=function(t){var e=t.interval,r=t.res,a=[];a.length=r;var n=(e[1]-e[0])/(r-1);for(let t=0;t<r;t++)a[t]=t*n+e[0];var s=[];return s.length=r,s.fill(0),{X:a,Y:s}},this.eval=function(e){var a=e.pos,n=e.estPara,s=r([a]);return{X:[a],Y:t.multiply(s,n)}},this.evalIntegral=function(t){var e=t.interval[0],r=t.interval[1],a=t.estPara;return a[0]*(r-e)+.5*a[1]*(Math.pow(r,2)-Math.pow(e,2))},this.calcFittedValues=function(e){var a=e.data.X,n=e.estPara,s=r(a);return{X:a,Y:t.multiply(s,n)}}};function s(t){this.data=!1,this.currentBasis=!1,this.knots=!1,this.regualizer=!1,this.lambda=0,this.estPara=!1,this.dof=0,Object.assign(this,t),t.basis&&(this.setBasis(t.basis),delete this.basis)}return s.prototype.bases={"trunc-power":r,linear:a},s.prototype.setBasis=function(t){var e=this.bases[t];this.currentBasis=e,this.knots||e.defaults.knots&&(this.knots=e.calcKnots(this.data)),this.regualizer||(this.regualizer=e.defaults.regualizer)},s.prototype.calcRegression=function(t){t&&Object.assign(this,t),t.basis&&(this.setBasis(t.basis),delete this.basis);var e=this.currentBasis.calcRegression({data:this.data,regualizer:this.regualizer,knots:this.knots,lambda:this.lambda});return this.estPara=e.estPara,this.dof=e.dof,e},s.prototype.analyticString=function(){return this.estPara||this.calcRegression(),this.currentBasis.analyticString({estPara:this.estPara,knots:this.knots})},s.prototype.sample=function(t,e){return this.estPara||this.calcRegression(),this.currentBasis.sample({interval:t,res:e,estPara:this.estPara,knots:this.knots})},s.prototype.sampleDer=function(t,e){return this.estPara||this.calcRegression(),this.currentBasis.sampleDer({interval:t,res:e,estPara:this.estPara,knots:this.knots})},s.prototype.sample2ndDer=function(t,e){return this.estPara||this.calcRegression(),this.currentBasis.sample2ndDer({interval:t,res:e,estPara:this.estPara,knots:this.knots})},s.prototype.eval=function(t){return this.estPara||this.calcRegression(),this.currentBasis.eval({pos:t,estPara:this.estPara,knots:this.knots})},s.prototype.evalIntegral=function(t){return this.estPara||this.calcRegression(),this.currentBasis.evalIntegral({inteval:t,estPara:this.estPara,knots:this.knots})},s});
