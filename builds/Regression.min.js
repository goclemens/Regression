!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("mathjs")):"function"==typeof define&&define.amd?define(["mathjs"],e):t.Regression=e(t.math)}(this,function(t){"use strict";t=t&&t.hasOwnProperty("default")?t.default:t;var e=function(){function e(e,r,a){var s=t.transpose(e);if(void 0==a||0==a)var n=t.multiply(t.inv(t.multiply(s,e)),s);else n=t.multiply(t.inv(t.add(t.multiply(s,e),a)),s);var i=t.multiply(n,r),o=t.multiply(e,i),l=t.multiply(e,n);return{estPara:i,fittedValues:o,projMatrix:l,dof:t.trace(l)}}return e.estPara=function(e,r,a){var s=t.transpose(e);if(void 0==a)var n=t.multiply(t.inv(t.multiply(s,e)),s);else n=t.multiply(t.inv(t.add(t.multiply(s,e),a)),s);return t.multiply(n,r)},e.fittedValues=function(e,r,a){var s=t.transpose(e);if(void 0==a)var n=t.multiply(t.inv(t.multiply(s,e)),s);else n=t.multiply(t.inv(t.add(t.multiply(s,e),a)),s);return t.multiply(e,t.multiply(n,r))},e.projMatrix=function(e,r,a){var s=t.transpose(e);if(void 0==a)var n=t.multiply(t.inv(t.multiply(s,e)),s);else n=t.multiply(t.inv(t.add(t.multiply(s,e),a)),s);return t.multiply(e,n)},e}(),r=new function(){function r(t,e){var r=e.length,a=[];a.length=t.length;for(let t=0;t<a.length;t++)a[t]=new Array(r+4);for(let s=0;s<t.length;s++){a[s][0]=1,a[s][1]=t[s],a[s][2]=Math.pow(t[s],2),a[s][3]=Math.pow(t[s],3);for(let n=0;n<r;n++)a[s][n+4]=Math.max(Math.pow(t[s]-e[n],3),0)}return a}function a(t,e){var r=e.length,a=[];a.length=t.length;for(let t=0;t<a.length;t++)a[t]=new Array(r+4);for(let s=0;s<t.length;s++){a[s][0]=0,a[s][1]=1,a[s][2]=2*t[s],a[s][3]=3*Math.pow(t[s],2);for(let n=0;n<r;n++)a[s][n+4]=t[s]>e[n]?3*Math.pow(t[s]-e[n],2):0}return a}function s(t,e){var r=e.length,a=[];a.length=t.length;for(let t=0;t<a.length;t++)a[t]=new Array(r+4);for(let s=0;s<t.length;s++){a[s][0]=0,a[s][1]=0,a[s][2]=2,a[s][3]=6*t[s];for(let n=0;n<r;n++)a[s][n+4]=t[s]>e[n]?6*(t[s]-e[n]):0}return a}this.defaults={regualizer:"Sq2ndDer",knots:!0},this.calcKnots=function(t){var e=t.X.map(t=>t);e.sort();for(let t=0;t<e.length-1;t++)e[t]==e[t+1]&&(e.splice(t,1),t--);return e},this.calcRegression=function(a){var s=a.data,n=a.knots,i=a.regualizer,o=a.lambda,l=a.interval||[n[0]-.05*(n[n.length-1]-n[0]),n[n.length-1]+.05*(n[n.length-1]-n[0])],h=r(s.X,n),u=function(e,r,a,s){switch(e){case"Sq2ndDer":var n=s[0],i=s[1],o=[];o.length=a.length+4;for(let t=0;t<o.length;t++)o[t]=new Array(o.length),o[t].fill(0);o[2][2]=4*(i-n),o[2][3]=6*(i*i-n*n),o[3][3]=12*(Math.pow(i,3)-Math.pow(n,3));for(let t=4;t<o.length;t++){o[t][2]=o[2][t]=6*i*(i-2*a[t-4])+6*Math.pow(a[t-4],2),o[t][3]=o[3][t]=6*Math.pow(i,2)*(2*i-3*a[t-4])+6*Math.pow(a[t-4],3);for(let e=t;e<o.length;e++)o[t][e]=o[e][t]=6*i*(i*(2*i-3*(a[t-4]+a[e-4]))+6*a[t-4]*a[e-4])+6*Math.pow(a[e-4],3)-18*Math.pow(a[e-4],2)*a[t-4]}return o=t.multiply(o,r);case"ridge":var o=t.multiply(t.eye(a.length+4).toArray(),r);return o[0][0]=0,o;case"none":var o=!1;return o;default:return console.log("truncPower: "+e+" is not a supported regualizer"),!1}}(i,o,n,l);return e(h,s.Y,u)},this.sample=function(e){var a=e.interval,s=e.res,n=e.estPara,i=e.knots,o=[];o.length=s;var l=(a[1]-a[0])/(s-1);for(let t=0;t<s;t++)o[t]=t*l+a[0];var h=r(o,i);return{X:o,Y:t.multiply(h,n)}},this.sampleDer=function(e){var r=e.interval,s=e.res,n=e.estPara,i=e.knots,o=[];o.length=s;var l=(r[1]-r[0])/(s-1);for(let t=0;t<s;t++)o[t]=t*l+r[0];var h=a(o,i);return{X:o,Y:t.multiply(h,n)}},this.sample2ndDer=function(e){var r=e.interval,a=e.res,n=e.estPara,i=e.knots,o=[];o.length=a;var l=(r[1]-r[0])/(a-1);for(let t=0;t<a;t++)o[t]=t*l+r[0];var h=s(o,i);return{X:o,Y:t.multiply(h,n)}},this.eval=function(e){var a=e.pos,s=e.knots,n=e.estPara,i=r([a],s);return{X:[a],Y:t.multiply(i,n)}},this.evalDer=function(e){var r=e.pos,s=e.knots,n=e.estPara,i=a([r],s);return{X:[r],Y:t.multiply(i,n)}},this.eval2ndDer=function(e){var r=e.pos,a=e.knots,n=e.estPara,i=s([r],a);return{X:[r],Y:t.multiply(i,n)}},this.evalIntegral=function(e){var r=e.interval,a=e.knots,s=e.estPara,i=function(t,e){var r=e.length,a=t[0],s=t[1],i=[];i.length=n+4,i[0]=s-a,i[1]=.5*(Math.pow(s,2)-Math.pow(a,2)),i[2]=1/3*(Math.pow(s,3)-Math.pow(a,3)),i[3]=.25*(Math.pow(s,4)-Math.pow(a,4));for(let t=0;t<r;t++)i[t+4]=0,a>e[t]&&(i[t+4]+=.25*Math.pow(a-e[t],4)),s>e[t]&&(i[t+4]+=.25*Math.pow(s-e[t],4)),knot[t]<0&&(i[t+4]-=.25*Math.pow(knot[t],4));return i}(r,a);return t.multiply(i,s)},this.calcFittedValues=function(e){var a=e.data.X,s=e.knots,n=e.estPara,i=r(a,s);return{X:a,Y:t.multiply(i,n)}},this.analyticString=function(t){var e=t.knots,r=t.estPara,a="";a+=r[0],a+=r[1]>=0?"+"+r[1]+"x":r[1]+"x",a+=r[2]>=0?"+"+r[2]+"x^2":r[2]+"x^2",a+=r[3]>=0?"+"+r[3]+"x^3":r[3]+"x^3";for(let t=0;t<e.length;t++)a+=r[t+4]>=0?"+"+r[t+4]:r[t+4],a+=e[t]>0?"(x"+-e[t]+")^3":NaN+-e[t]+")^3";return a},this.roots=function(t){return console.log("!!!! roots not implemented yet !!!!"),[]},this.rootsDer=function(t){var e,r=t.knots,a=t.estPara,s=t.dataInterval,n=[],i=a[1],o=2*a[2],l=3*a[3];if(0!=a[3]){if((h=Math.pow(o,2)-4*l*i)>=0){let t=Math.sqrt(h);(e=(-o+t)/(2*l))>=s[0]&&e<=r[0]&&n.push(e),(e=(-o-t)/(2*l))>=s[0]&&e<=r[0]&&n.push(e)}}else 0!=a[2]?(e=-i/o)>=s[0]&&e<=r[0]&&n.push(e):(a[1]=0)&&n.push([s[0],r[0]]);for(let t=0;t<r.length;t++){i=a[1],o=2*a[2],l=3*a[3];for(let e=0;e<=t;e++)i+=3*a[4+e]*Math.pow(r[e],2),o+=-6*a[4+e]*r[e],l+=3*a[4+e];if(0!=l){var h=Math.pow(o,2)-4*l*i,u=r[t+1]||s[1];if(h>=0){let a=Math.sqrt(h);(e=(-o+a)/(2*l))>r[t]&&e<=u&&n.push(e),(e=(-o-a)/(2*l))>r[t]&&e<=u&&n.push(e)}}else 0!=o?(e=-i/o)>r[t]&&e<=u&&n.push(e):(i=0)&&n.push([r[t],u])}return n},this.roots2ndDer=function(t){var e,r=t.knots,a=t.estPara,s=t.dataInterval,n=[];0!=a[3]?(e=-2*a[2]/(6*a[3]))>=s[0]&&e<=r[0]&&n.push(e):(a[2]=0)&&n.push([s[0],r[0]]);for(let t=0;t<r.length;t++){var i=2*a[2],o=6*a[3];for(let e=0;e<=t;e++)i+=-6*a[4+e]*r[e],o+=6*a[4+e];var l=r[t+1]||s[1];0!=o?(e=-i/o)>r[t]&&e<=l&&n.push(e):(a[2]=0)&&n.push([r[t],l])}return n}},a=new function(){function r(t){var e=[];e.length=t.length;for(let t=0;t<e.length;t++)e[t]=new Array(2);for(let r=0;r<t.length;r++)e[r][0]=1,e[r][1]=t[r];return e}this.defaults={regualizer:"none",knots:!1},this.calcKnots=function(){return console.log("linear - no knots needed for this basis"),!1},this.calcRegression=function(t){var a=t.data,s=t.regualizer,n=t.lambda,i=r(a.X),o=function(t,e){switch(t){case"ridge":var r=[[0,0],[0,e]];return r;case"none":var r=!1;return r;default:return console.log("truncPower: "+t+" is not a supported regualizer"),!1}}(s,n);return e(i,a.Y,o)},this.analyticString=function(t){var e=t.estPara,r="";return r+=e[0],r+=e[1]>=0?"+"+e[1]+"x":e[1]+"x"},this.sample=function(e){var a=e.interval,s=e.res,n=e.estPara,i=[];i.length=s;var o=(a[1]-a[0])/(s-1);for(let t=0;t<s;t++)i[t]=t*o+a[0];var l=r(i);return{X:i,Y:t.multiply(l,n)}},this.sampleDer=function(t){var e=t.interval,r=t.res,a=t.estPara,s=[];s.length=r;var n=(e[1]-e[0])/(r-1);for(let t=0;t<r;t++)s[t]=t*n+e[0];var i=[];return i.length=r,i.fill(a[0]),{X:s,Y:i}},this.sample2ndDer=function(t){var e=t.interval,r=t.res,a=[];a.length=r;var s=(e[1]-e[0])/(r-1);for(let t=0;t<r;t++)a[t]=t*s+e[0];var n=[];return n.length=r,n.fill(0),{X:a,Y:n}},this.eval=function(e){var a=e.pos,s=e.estPara,n=r([a]);return{X:[a],Y:t.multiply(n,s)}},this.evalDer=function(t){return{X:[t.pos],Y:[t.estPara[0]]}},this.eval2ndDer=function(t){var e=t.pos;t.estPara;return{X:[e],Y:[0]}},this.evalIntegral=function(t){var e=t.interval[0],r=t.interval[1],a=t.estPara;return a[0]*(r-e)+.5*a[1]*(Math.pow(r,2)-Math.pow(e,2))},this.calcFittedValues=function(e){var a=e.data.X,s=e.estPara,n=r(a);return{X:a,Y:t.multiply(n,s)}},this.roots=function(t){var e=t.estPara,r=t.dataInterval;return 0!=e[1]?[-e[0]/e[1]]:0==e[0]?[r]:[]},this.rootsDer=function(t){var e=t.estPara,r=t.dataInterval;return 0==e[1]?[r]:[]},this.roots2ndDer=function(t){return[t.dataInterval]}};function s(t){this.data=!1,this.currentBasis=!1,this.knots=!1,this.regualizer=!1,this.lambda=.01,this.estPara=!1,this.dof=0,Object.assign(this,t),t.basis&&(this.setBasis(t.basis),delete this.basis)}return s.prototype.calcRegression=function(t){if(t&&(Object.assign(this,t),t.basis&&(this.setBasis(t.basis),delete this.basis)),!this.data)return console.log("Regression - data is not defined"),!1;this.dataInterval=[this.data.X[0],this.data.X[this.data.X.length-1]];var e=this.currentBasis.calcRegression({data:this.data,regualizer:this.regualizer,knots:this.knots,lambda:this.lambda});return this.estPara=e.estPara,this.dof=e.dof,e},s.prototype.sample=function(t,e){return this.estPara||this.calcRegression(),this.currentBasis.sample({interval:t,res:e,estPara:this.estPara,knots:this.knots})},s.prototype.sampleDer=function(t,e){return this.estPara||this.calcRegression(),this.currentBasis.sampleDer({interval:t,res:e,estPara:this.estPara,knots:this.knots})},s.prototype.sample2ndDer=function(t,e){return this.estPara||this.calcRegression(),this.currentBasis.sample2ndDer({interval:t,res:e,estPara:this.estPara,knots:this.knots})},s.prototype.analyticString=function(){return this.estPara||this.calcRegression(),this.currentBasis.analyticString({estPara:this.estPara,knots:this.knots})},s.prototype.eval=function(t){return this.estPara||this.calcRegression(),this.currentBasis.eval({pos:t,estPara:this.estPara,knots:this.knots})},s.prototype.evalDer=function(t){return this.estPara||this.calcRegression(),this.currentBasis.evalDer({pos:t,estPara:this.estPara,knots:this.knots})},s.prototype.eval2ndDer=function(t){return this.estPara||this.calcRegression(),this.currentBasis.eval2ndDer({pos:t,estPara:this.estPara,knots:this.knots})},s.prototype.evalIntegral=function(t){return this.estPara||this.calcRegression(),this.currentBasis.evalIntegral({inteval:t,estPara:this.estPara,knots:this.knots})},s.prototype.mean=function(t){return this.evalIntegral(t)/(t[1]-t[0])},s.prototype.meanDer=function(t){return(this.eval(t[1])-this.eval(t[0]))/(t[1]-t[0])},s.prototype.mean2ndDer=function(t){return(this.evalDer(t[1])-this.evalDer(t[0]))/(t[1]-t[0])},s.prototype.rootsAll=function(){return{func:this.currentBasis.roots({dataInterval:this.dataInterval,estPara:this.estPara,knots:this.knots}),der:this.currentBasis.rootsDer({dataInterval:this.dataInterval,estPara:this.estPara,knots:this.knots}),secDer:this.currentBasis.roots2ndDer({dataInterval:this.dataInterval,estPara:this.estPara,knots:this.knots})}},s.prototype.roots=function(){return this.currentBasis.roots({dataInterval:this.dataInterval,estPara:this.estPara,knots:this.knots})},s.prototype.rootsDer=function(){return this.currentBasis.rootsDer({dataInterval:this.dataInterval,estPara:this.estPara,knots:this.knots})},s.prototype.roots2ndDer=function(){return this.currentBasis.roots2ndDer({dataInterval:this.dataInterval,estPara:this.estPara,knots:this.knots})},s.prototype.extrema=function(){var t=[],e=[],r=[],a=this.rootsDer(),s=a.length;for(let s=0;s<a.length;s++){if(Array.isArray(a[s])){r.push(a[s]);continue}let n=this.eval2ndDer(a[s]).Y;if(n<0)t.push(a[s]);else if(n>0)e.push(a[s]);else{let n=(this.dataInterval[1]-this.dataInterval[0])/1e4,i=this.evalDer(a[s]-n).Y,o=this.evalDer(a[s]+n).Y;i<a[s]&&o<a[s]?t.push(a[s]):i>a[s]&&o>a[s]?e.push(a[s]):r.push(a[s])}}return{max:t,min:e,saddle:r,num:s}},s.prototype.bases={"trunc-power":r,linear:a},s.prototype.setBasis=function(t){var e=this.bases[t];this.currentBasis=e,this.knots||e.defaults.knots&&(this.knots=e.calcKnots(this.data)),this.regualizer||(this.regualizer=e.defaults.regualizer)},s});
